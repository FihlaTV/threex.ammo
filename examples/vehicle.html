<!DOCTYPE html>
<meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
<script src='vendor/three.js/build/three.min.js'></script>
<script src='vendor/three.js/examples/js/controls/OrbitControls.js'></script>
<script src="vendor/three.js/examples/js/loaders/BinaryLoader.js"></script>
<script src='vendor/three.js/examples/js/libs/stats.min.js'></script>
<script src='vendor/three.js/examples/js/libs/ammo.js'></script>
<script src='../threex-ammoworld.js'></script>
<script src='../threex-ammocontrols.js'></script>
<script src='../threex-ammovehicle.js'></script>

<script src='js/startupthree.js/startupThree.js'></script>
<body style='margin: 0px; overflow: hidden; text-align:center;'>

<script src="vendor/threex.sportballs/threex.sportballs.js"></script>
<script>THREEx.SportBalls.baseURL='vendor/threex.sportballs/'</script>

<script src='vendor/threex.poolball/threex.poolball.js'></script>

<div style='position: absolute; top: 0px; width: 100%;font-family:arial; font-weight: bolder; padding-top: 5px; color: white;'>
	Playing with <a href="http://threejs.org" target="_blank">three.js</a>
	and <a href="https://github.com/kripken/ammo.js/">ammo.js</a> 
	- More ammo.js <a href="index.html">examples</a>
	<br> Use arrow to move the vehicle
</div>

<style>
	#speedometer {
		color: #ffffff;
		background-color: #990000;
		position: absolute;
		bottom: 0px;
		padding: 5px;
	}
</style>
<div id='speedometer'>0.0 km/h</div>



<script>

startUpTHREEjs(window, {
		// stats : false,
		// cameraControls : false
	}, function(demo){

        controls.enableKeys = false

//////////////////////////////////////////////////////////////////////////////////
//		set 3 point lighting						//
//////////////////////////////////////////////////////////////////////////////////

;(function(){
	// add a ambient light
	var light	= new THREE.AmbientLight( 0x020202 ) 
	scene.add( light )
	// add a light in front
	var light	= new THREE.DirectionalLight('white', 0.2)
	light.position.set(0.5, 0.5, -2)
	scene.add( light ) 
})()


;(function(){
	var dirLight = new THREE.DirectionalLight( 0xffffff, 0.8 );
	dirLight.position.set( -15, 15, 15 );
	dirLight.castShadow = true;
	dirLight.shadow.bias = -0.003
	dirLight.shadow.bias = 0.001
	dirLight.shadow.camera.near = 1;
	dirLight.shadow.camera.far = 50;
	dirLight.shadow.camera.right = 25;
	dirLight.shadow.camera.left = - 25;
	dirLight.shadow.camera.top	= 25;
	dirLight.shadow.camera.bottom = - 25;
	dirLight.shadow.mapSize.x = 1024;
	dirLight.shadow.mapSize.y = 1024;
	scene.add( dirLight );
window.dirLight = dirLight
	// scene.add( new THREE.CameraHelper( dirLight.shadow.camera ) );	
})()
        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////
	camera.position.x = -4.84;
	camera.position.y = 4.39;
	camera.position.z = -35.11;
	camera.lookAt( new THREE.Vector3( 0.33, -0.40, 0.85 ) );
        
        ////////////////////////////////////////////////////////////////////////////////
        //          Code Separator
        ////////////////////////////////////////////////////////////////////////////////

        var ammoWorld = new THREEx.AmmoWorld()
        onRenderFcts.push(function(){
        	ammoWorld.update()
        })

        //////////////////////////////////////////////////////////////////////////////
        //                add vehicule
        //////////////////////////////////////////////////////////////////////////////

        // vehicule
	var ammoVehicle = new THREEx.AmmoVehicle(ammoWorld, new THREE.Vector3(0, 4, -20), new THREE.Quaternion(0, 0, 0, 1));
        scene.add(ammoVehicle.object3d)

        //////////////////////////////////////////////////////////////////////////////
        //                update speedometer
        //////////////////////////////////////////////////////////////////////////////

        var speedometer = document.getElementById( 'speedometer' );
        onRenderFcts.push(function(){
		var speed = ammoVehicle.vehicle.getCurrentSpeedKmHour();

		speedometer.innerHTML = (speed < 0 ? '(R) ' : '') + Math.abs(speed).toFixed(1) + ' km/h';                
        })

        //////////////////////////////////////////////////////////////////////////////
        //                handle keyboard
        //////////////////////////////////////////////////////////////////////////////
	var keysActions = {
		'w':'acceleration',
		'ArrowUp':'acceleration',
		'i':'acceleration',
		's':'braking',
		'ArrowDown':'braking',
		'k':'braking',
		'a':'left',
		'ArrowLeft':'left',
		'j':'left',
		'd':'right',
		'ArrowRight':'right',
		'l':'right',
	};
                        
	window.addEventListener( 'keydown', function keydown(event) {
		if(keysActions[event.key] === undefined ) return
		ammoVehicle.actions[keysActions[event.key]] = true;
		event.preventDefault();
		event.stopPropagation();
	});
	window.addEventListener( 'keyup', function keyup(event) {
		if(keysActions[event.key] === undefined ) return
		ammoVehicle.actions[keysActions[event.key]] = false;
		event.preventDefault();
		event.stopPropagation();
	});

////////////////////////////////////////////////////////////////////////////////
//          display ground
////////////////////////////////////////////////////////////////////////////////

;(function(){
// return
	var geometry = new THREE.BoxGeometry(75,0.1,75)
        var material = new THREE.MeshPhongMaterial({
		map: new THREE.TextureLoader().load("textures/grid.png", function onLoad(texture){
			texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
			texture.repeat.set(geometry.parameters.width,geometry.parameters.depth)
			texture.anisotropy = renderer.getMaxAnisotropy()
		})
	});
        var mesh = new THREE.Mesh(geometry, material)
	mesh.position.y = -mesh.geometry.parameters.height/2
	mesh.receiveShadow = true
        scene.add(mesh)
	mesh.name = 'ground'

	var ammoControls = new THREEx.AmmoControls(mesh, {
		mass: 0
	})
	ammoControls.setFriction(0.9)
	ammoControls.setRestitution(0.9)
	ammoWorld.add(ammoControls)	
})()

////////////////////////////////////////////////////////////////////////////////
//          display tremplin
////////////////////////////////////////////////////////////////////////////////

;(function(){
// return
	var geometry = new THREE.BoxGeometry(8,4,10)
        var material = new THREE.MeshPhongMaterial({
		map: new THREE.TextureLoader().load("textures/grid.png", function onLoad(texture){
			texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
			texture.repeat.set(geometry.parameters.width,geometry.parameters.depth)
			texture.anisotropy = renderer.getMaxAnisotropy()
		})
	});
        var mesh = new THREE.Mesh(geometry, material)
	mesh.position.y = -mesh.geometry.parameters.height/2 +0.5
	mesh.receiveShadow = true
        scene.add(mesh)
	mesh.name = 'tremplin'
        
	var quaternion = new THREE.Quaternion(0, 0, 0, 1);
	quaternion.setFromAxisAngle(new THREE.Vector3(1, 0, 0), -Math.PI / 18);
        mesh.quaternion.copy(quaternion)        

	var ammoControls = new THREEx.AmmoControls(mesh, {
		mass: 0
	})
	ammoControls.setFriction(0.9)
	ammoControls.setRestitution(0.9)
	ammoWorld.add(ammoControls)	
})()

//////////////////////////////////////////////////////////////////////////////
//                Code Separator
//////////////////////////////////////////////////////////////////////////////
;(function(){
return
        // var mesh = THREEx.createPoolBall()
	// var mesh = THREEx.SportBalls.createBasket()
	var mesh = THREEx.SportBalls.createBeach()
	// var mesh = THREEx.SportBalls.createFootball()/
        mesh.scale.multiplyScalar(3)
        mesh.position.x = -6
        mesh.position.y = 4

	mesh.castShadow = true
	mesh.receiveShadow = true
	
	mesh.quaternion.set(Math.random(), Math.random(), Math.random(), 1).normalize()

        scene.add(mesh)
        
	var ammoControls = new THREEx.AmmoControls(mesh)
	// ammoControls.setFriction(0.9)
	// ammoControls.setRestitution(0.9)
	ammoWorld.add(ammoControls)	
})()

////////////////////////////////////////////////////////////////////////////////
//          Pile of crate
////////////////////////////////////////////////////////////////////////////////
;(function(){
// return
	var geometry = new THREE.BoxGeometry(0.75, 0.75, 0.75)
	var material = new THREE.MeshPhongMaterial({
	});
	var model = new THREE.Mesh(geometry, material)
	model.castShadow = true
	model.receiveShadow = true

	var size = new THREE.Vector3().set(8,6,1)
	buildCratesPile(size)

        return

	function buildCratesPile( nCubes){		
		for(var x = 0; x < nCubes.x; x++){
			for(var y = 0; y < nCubes.y; y++){
				for(var z = 0; z < nCubes.z; z++){
					var mesh = model.clone()

					mesh.position.x = (x-nCubes.x/2+0.5) * mesh.scale.x * geometry.parameters.width
					mesh.position.y = (y-nCubes.y/2+0.5) * mesh.scale.y * geometry.parameters.height
					mesh.position.z = (z-nCubes.z/2+0.5) * mesh.scale.z * geometry.parameters.depth

					mesh.position.y += nCubes.y/2 * mesh.scale.y * geometry.parameters.height
					mesh.position.z += 6
				        scene.add(mesh)
				        
					var ammoControls = new THREEx.AmmoControls(mesh)
					ammoWorld.add(ammoControls)	
				}
			}
		}
	}
})()

//////////////////////////////////////////////////////////////////////////////
//                Code Separator
//////////////////////////////////////////////////////////////////////////////
        
;(function(){
// return
        // Vehicle
        var wheelLoader = new THREE.BinaryLoader();
        wheelLoader.load("./obj/veyron/parts/veyron_wheel_bin.js", function(wheelGeometry){
        	
        	var bodyLoader = new THREE.BinaryLoader();
        	bodyLoader.load("./obj/veyron/parts/veyron_body_bin.js", function(bodyGeometry){

                        var s = 0.02
        		bodyGeometry.computeBoundingBox();
        		var bodybb = bodyGeometry.boundingBox;
        		var textureCube = new THREE.CubeTextureLoader()
        			.setPath( 'textures/cube/Bridge2/')
        			.load( [ 'posx.jpg', 'negx.jpg', 'posy.jpg', 'negy.jpg', 'posz.jpg', 'negz.jpg' ] );

        		var bodyMesh = new THREE.Mesh(bodyGeometry, new THREE.MeshLambertMaterial({
        			color: 0xffffff, 
        			envMap: textureCube, 
        			combine: THREE.MixOperation, 
        			reflectivity: 0.2,
        		}));
        		bodyMesh.scale.x = bodyMesh.scale.y = bodyMesh.scale.z = s;
	bodyMesh.castShadow = true
	bodyMesh.receiveShadow = true
        		scene.add(bodyMesh);
                        bodyMesh.position.x += 10

        		var wheelMeshes = [new THREE.Object3D(),
        			new THREE.Object3D(),
        			new THREE.Object3D(),
        			new THREE.Object3D()];
                                
                        var wheelMaterial = new THREE.MultiMaterial()
        		wheelMaterial.materials[ 0 ] = new THREE.MeshLambertMaterial({
                                color: 0xffffff,
                                reflectivity:0.75,
        			envMap: textureCube, 
        			combine: THREE.MixOperation, 
                        });
        		wheelMaterial.materials[ 1 ] = new THREE.MeshLambertMaterial({
                                color: 0x333333,
                        });
        		
        		for(var i=0; i< wheelMeshes.length; i++){
        			
        			var wheelmesh = new THREE.Mesh(wheelGeometry, wheelMaterial);
                                                                wheelmesh.castShadow = true
                                                                wheelmesh.receiveShadow = true

        			wheelmesh.scale.set(s,s,s);
        			wheelGeometry.computeBoundingBox();
        			var bb = wheelGeometry.boundingBox;
        			// debugger
        			wheelmesh.position.set(
        				-s*(bb.max.x+bb.min.x)*0.5,
        				-s*(bb.max.y+bb.min.y)*0.5,
        				-s*(bb.max.z+bb.min.z)*0.5);
        			wheelMeshes[i].add(wheelmesh);

	                        wheelMeshes[i].position.y = (bodybb.max.y+bodybb.min.y)*s/2 * 0.5;
        			if(i==0){
        	                        wheelMeshes[i].position.x = (bodybb.max.x-bodybb.min.x)*s/2 * -0.9;
        	                        wheelMeshes[i].position.z = (bodybb.max.z-bodybb.min.z)*s/2 * -0.635;
                                }else if( i === 3 ){
        	                        wheelMeshes[i].position.x = (bodybb.max.x-bodybb.min.x)*s/2 * -0.9;
        	                        wheelMeshes[i].position.z = (bodybb.max.z-bodybb.min.z)*s/2 * +0.615;                                        
                                }else if( i === 1 ){
        	                        wheelMeshes[i].position.x = (bodybb.max.x-bodybb.min.x)*s/2 * +0.9;
        	                        wheelMeshes[i].position.z = (bodybb.max.z-bodybb.min.z)*s/2 * -0.635;
                                }else if( i === 2 ){
        	                        wheelMeshes[i].position.x = (bodybb.max.x-bodybb.min.x)*s/2 * +0.9;
        	                        wheelMeshes[i].position.z = (bodybb.max.z-bodybb.min.z)*s/2 * +0.615;
                                }

        			if(i==0 || i==3){
        				wheelMeshes[i].quaternion.setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI);				
        			}
        			scene.add(wheelMeshes[i])
                                wheelMeshes[i].position.x += 10
        		}
                
        	});
        });
})();

//////////////////////////////////////////////////////////////////////////////
//                Code Separator
//////////////////////////////////////////////////////////////////////////////
        
;(function(){
// return
        // Vehicle
        var wheelLoader = new THREE.BinaryLoader();
        wheelLoader.load("./obj/gallardo/parts/gallardo_wheel_bin.js", function(wheelGeometry){
        	
        	var bodyLoader = new THREE.BinaryLoader();
        	bodyLoader.load("./obj/gallardo/parts/gallardo_body_bin.js", function(bodyGeometry){

                        var s = 0.02
        		bodyGeometry.computeBoundingBox();
        		var bodybb = bodyGeometry.boundingBox;
        		var textureCube = new THREE.CubeTextureLoader()
        			.setPath( 'textures/cube/Bridge2/')
        			.load( [ 'posx.jpg', 'negx.jpg', 'posy.jpg', 'negy.jpg', 'posz.jpg', 'negz.jpg' ] );

        		var bodyMesh = new THREE.Mesh(bodyGeometry, new THREE.MeshLambertMaterial({
        			color: 0xffffff, 
        			envMap: textureCube, 
        			combine: THREE.MixOperation, 
        			reflectivity: 0.2,
        		}));
        		bodyMesh.scale.x = bodyMesh.scale.y = bodyMesh.scale.z = s;
	bodyMesh.castShadow = true
	bodyMesh.receiveShadow = true
        		scene.add(bodyMesh);
                        bodyMesh.position.x += 20

        		var wheelMeshes = [new THREE.Object3D(),
        			new THREE.Object3D(),
        			new THREE.Object3D(),
        			new THREE.Object3D()];
                                
                        var wheelMaterial = new THREE.MultiMaterial()
        		wheelMaterial.materials[ 0 ] = new THREE.MeshLambertMaterial({
                                color: 0xffffff,
                                reflectivity:0.75,
        			envMap: textureCube, 
        			combine: THREE.MixOperation, 
                        });
        		wheelMaterial.materials[ 1 ] = new THREE.MeshLambertMaterial({
                                color: 0x333333,
                        });
        		
        		for(var i=0; i< wheelMeshes.length; i++){
        			
        			var wheelmesh = new THREE.Mesh(wheelGeometry, wheelMaterial);
                                wheelmesh.castShadow = true
                                wheelmesh.receiveShadow = true

        			wheelmesh.scale.set(s,s,s);
        			wheelGeometry.computeBoundingBox();
        			var bb = wheelGeometry.boundingBox;
        			// debugger
        			wheelmesh.position.set(
        				-s*(bb.max.x+bb.min.x)*0.5,
        				-s*(bb.max.y+bb.min.y)*0.5,
        				-s*(bb.max.z+bb.min.z)*0.5);
        			wheelMeshes[i].add(wheelmesh);

	                        wheelMeshes[i].position.y = (bodybb.max.y+bodybb.min.y)*s/2;
        			if(i==0){
        	                        wheelMeshes[i].position.x = (bodybb.max.x-bodybb.min.x)*s/2 * -0.9;
        	                        wheelMeshes[i].position.z = (bodybb.max.z-bodybb.min.z)*s/2 * -0.635;
                                }else if( i === 3 ){
        	                        wheelMeshes[i].position.x = (bodybb.max.x-bodybb.min.x)*s/2 * -0.9;
        	                        wheelMeshes[i].position.z = (bodybb.max.z-bodybb.min.z)*s/2 * +0.615;                                        
                                }else if( i === 1 ){
        	                        wheelMeshes[i].position.x = (bodybb.max.x-bodybb.min.x)*s/2 * +0.9;
        	                        wheelMeshes[i].position.z = (bodybb.max.z-bodybb.min.z)*s/2 * -0.635;
                                }else if( i === 2 ){
        	                        wheelMeshes[i].position.x = (bodybb.max.x-bodybb.min.x)*s/2 * +0.9;
        	                        wheelMeshes[i].position.z = (bodybb.max.z-bodybb.min.z)*s/2 * +0.615;
                                }

        			if(i==0 || i==3){
        				wheelMeshes[i].quaternion.setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI);				
        			}
        			scene.add(wheelMeshes[i])
                                wheelMeshes[i].position.x += 20
        		}
        	});
        });
})();



//////////////////////////////////////////////////////////////////////////////
//		Code Separator
//////////////////////////////////////////////////////////////////////////////

;(function(){

	window.addEventListener("gamepadconnected", function(e) {
	  console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
	    e.gamepad.index, e.gamepad.id,
	    e.gamepad.buttons.length, e.gamepad.axes.length);
	});	
	
	window.addEventListener("gamepaddisconnected", function(e) {
		console.log("Gamepad disconnected from index %d: %s",
		e.gamepad.index, e.gamepad.id);
	});
})()

});
</script></body>
