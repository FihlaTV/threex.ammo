<!DOCTYPE html>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script src='vendor/three.js/build/three.min.js'></script>
<script src='vendor/three.js/examples/js/controls/OrbitControls.js'></script>
<script src="vendor/three.js/examples/js/libs/stats.min.js"></script>
<script src="vendor/three.js/examples/js/libs/ammo.js"></script>
<script src="../threex-ammoworld.js"></script>
<script src="../threex-ammocontrols.js"></script>

<script src='js/startupthree.js/startupThree.js'></script>
<body style='margin: 0px; overflow: hidden; text-align:center;'>

        <style>
			#speedometer {
				color: #ffffff;
				background-color: #990000;
				position: absolute;
				bottom: 0px;
				padding: 5px;
			}
        </style>
	<div id="speedometer">0.0 km/h</div>



<script>

startUpTHREEjs(window, {
		// stats : false,
		// cameraControls : false
	}, function(demo){
	

//////////////////////////////////////////////////////////////////////////////////
//		set 3 point lighting						//
//////////////////////////////////////////////////////////////////////////////////

;(function(){
	// add a ambient light
	var light	= new THREE.AmbientLight( 0x020202 ) 
	scene.add( light )
	// add a light in front
	var light	= new THREE.DirectionalLight('white', 0.2)
	light.position.set(0.5, 0.5, -2)
	scene.add( light ) 
})()


;(function(){
	var dirLight = new THREE.DirectionalLight( 0xffffff, 0.8 );
	dirLight.position.set( -15, 15, 15 );
	dirLight.castShadow = true;
	dirLight.shadow.bias = 0.001
	dirLight.shadow.camera.near = 1;
	dirLight.shadow.camera.far = 50;
	dirLight.shadow.camera.right = 25;
	dirLight.shadow.camera.left = - 25;
	dirLight.shadow.camera.top	= 25;
	dirLight.shadow.camera.bottom = - 25;
	dirLight.shadow.mapSize.x = 1024;
	dirLight.shadow.mapSize.y = 1024;
	scene.add( dirLight );
	// scene.add( new THREE.CameraHelper( dirLight.shadow.camera ) );	
})()
        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////
	camera.position.x = -4.84;
	camera.position.y = 4.39;
	camera.position.z = -35.11;
	camera.lookAt( new THREE.Vector3( 0.33, -0.40, 0.85 ) );
        
        ////////////////////////////////////////////////////////////////////////////////
        //          Code Separator
        ////////////////////////////////////////////////////////////////////////////////

        var ammoWorld = new THREEx.AmmoWorld()
        onRenderFcts.push(function(){
        	ammoWorld.update()
        })

        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////

var speedometer = document.getElementById( 'speedometer' );

	// - Global variables -
	var DISABLE_DEACTIVATION = 4;
	var TRANSFORM_AUX = new Ammo.btTransform();
	var ZERO_QUATERNION = new THREE.Quaternion(0, 0, 0, 1);

	// Graphics variables
	var materialDynamic = new THREE.MeshPhongMaterial({
                color: 'lightblue'
        })
        var materialStatic = new THREE.MeshPhongMaterial({
                color: 'lightgreen'
        })
        var materialInteractive = new THREE.MeshPhongMaterial()

        
        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////
	// Keybord actions
	var actions = {};
	var keysActions = {
		"KeyW":'acceleration',
		"KeyS":'braking',
		"KeyA":'left',
		"KeyD":'right'
	};
                        
	window.addEventListener( 'keydown', keydown);
	window.addEventListener( 'keyup', keyup);
	function keyup(e) {
		if(keysActions[e.code]) {
			actions[keysActions[e.code]] = false;
			e.preventDefault();
			e.stopPropagation();
			return false;
		}
	}
	function keydown(e) {
		if(keysActions[e.code]) {
			actions[keysActions[e.code]] = true;
			e.preventDefault();
			e.stopPropagation();
			return false;
		}
	}
        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////

	function createBox(pos, quat, w, l, h, mass, friction) {
		var material = mass > 0 ? materialDynamic : materialStatic;
		var shape = new THREE.BoxGeometry(w, l, h, 1, 1, 1);
		var geometry = new Ammo.btBoxShape(new Ammo.btVector3(w * 0.5, l * 0.5, h * 0.5));

		if(!mass) mass = 0;
		if(!friction) friction = 1;

		var mesh = new THREE.Mesh(shape, material);
                mesh.castShadow = true
                mesh.receiveShadow = true
		mesh.position.copy(pos);
		mesh.quaternion.copy(quat);
		scene.add( mesh );

		var transform = new Ammo.btTransform();
		transform.setIdentity();
		transform.setOrigin(new Ammo.btVector3(pos.x, pos.y, pos.z));
		transform.setRotation(new Ammo.btQuaternion(quat.x, quat.y, quat.z, quat.w));
		var motionState = new Ammo.btDefaultMotionState(transform);

		var localInertia = new Ammo.btVector3(0, 0, 0);
		geometry.calculateLocalInertia(mass, localInertia);

		var rbInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, geometry, localInertia);
		var body = new Ammo.btRigidBody(rbInfo);

		body.setFriction(friction);
		//body.setRestitution(.9);
		//body.setDamping(0.2, 0.2);

		ammoWorld.physicsWorld.addRigidBody( body );

		if (mass > 0) {
			body.setActivationState(DISABLE_DEACTIVATION);
			// Sync physics and graphics
			function sync(dt) {
				var ms = body.getMotionState();
				if (ms) {
					ms.getWorldTransform(TRANSFORM_AUX);
					var p = TRANSFORM_AUX.getOrigin();
					var q = TRANSFORM_AUX.getRotation();
					mesh.position.set(p.x(), p.y(), p.z());
					mesh.quaternion.set(q.x(), q.y(), q.z(), q.w());
				}
			}

			onRenderFcts.push(sync);
		}
	}

        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////

	function createWheelMesh(radius, width) {
		var geometry = new THREE.CylinderGeometry(radius, radius, width, 24, 1);
		geometry.rotateZ(Math.PI / 2);
		var wheelMesh = new THREE.Mesh(geometry, materialInteractive);
                wheelMesh.castShadow = true

                var geometry = new THREE.BoxGeometry(width * 1.5, radius * 1.75, radius*.25, 1, 1, 1)
                var boxMesh  = new THREE.Mesh(geometry, materialInteractive);
		wheelMesh.add(boxMesh);

		scene.add(wheelMesh)

		return wheelMesh
	}

	function createChassisMesh(width, height, depth) {
		var shape = new THREE.BoxGeometry(width, height, depth, 1, 1, 1);
		var mesh = new THREE.Mesh(shape, materialInteractive);
                mesh.castShadow = true
		scene.add(mesh);
		return mesh;
	}

	function createVehicle(pos, quat) {

		// Vehicle contants

		var chassisWidth = 1.8;
		var chassisHeight = .6;
		var chassisLength = 4;
		var massVehicle = 800;

		var wheelAxisPositionBack = -1.4;
		var wheelHalfTrackBack = 1;
		var wheelAxisHeightBack = .3;
		var wheelRadiusBack = .6;
		var wheelWidthBack = .3;

		var wheelAxisPositionFront = 1.4;
		var wheelHalfTrackFront = 1;
		var wheelAxisHeightFront = .3;
		var wheelRadiusFront = .35;
		var wheelWidthFront = .2;

		var friction = 1000;
		var suspensionStiffness = 20.0;
		var suspensionDamping = 2.3;
		var suspensionCompression = 4.4;
		var suspensionRestLength = 0.6;
		var rollInfluence = 0.2;

		var steeringIncrement = .04;
		var steeringClamp = .5;
		var maxEngineForce = 2000;
		var maxBreakingForce = 100;

		// Chassis
		var geometry = new Ammo.btBoxShape(new Ammo.btVector3(chassisWidth * .5, chassisHeight * .5, chassisLength * .5));
		var transform = new Ammo.btTransform();
		transform.setIdentity();
		transform.setOrigin(new Ammo.btVector3(pos.x, pos.y, pos.z));
		transform.setRotation(new Ammo.btQuaternion(quat.x, quat.y, quat.z, quat.w));
		var motionState = new Ammo.btDefaultMotionState(transform);
		var localInertia = new Ammo.btVector3(0, 0, 0);
		geometry.calculateLocalInertia(massVehicle, localInertia);
		var body = new Ammo.btRigidBody(new Ammo.btRigidBodyConstructionInfo(massVehicle, motionState, geometry, localInertia));
		body.setActivationState(DISABLE_DEACTIVATION);
		ammoWorld.physicsWorld.addRigidBody(body);
		var chassisMesh = createChassisMesh(chassisWidth, chassisHeight, chassisLength);

		// Raycast Vehicle
		var engineForce = 0;
		var vehicleSteering = 0;
		var breakingForce = 0;
		var tuning = new Ammo.btVehicleTuning();
		var rayCaster = new Ammo.btDefaultVehicleRaycaster(ammoWorld.physicsWorld);
		var vehicle = new Ammo.btRaycastVehicle(tuning, body, rayCaster);
		vehicle.setCoordinateSystem(0, 1, 2);
		ammoWorld.physicsWorld.addAction(vehicle);

		// Wheels
		var FRONT_LEFT = 0;
		var FRONT_RIGHT = 1;
		var BACK_LEFT = 2;
		var BACK_RIGHT = 3;
		var wheelMeshes = [];
		var wheelDirectionCS0 = new Ammo.btVector3(0, -1, 0);
		var wheelAxleCS = new Ammo.btVector3(-1, 0, 0);

		function addWheel(isFront, pos, radius, width, index) {

			var wheelInfo = vehicle.addWheel(
					pos,
					wheelDirectionCS0,
					wheelAxleCS,
					suspensionRestLength,
					radius,
					tuning,
					isFront);

			wheelInfo.set_m_suspensionStiffness(suspensionStiffness);
			wheelInfo.set_m_wheelsDampingRelaxation(suspensionDamping);
			wheelInfo.set_m_wheelsDampingCompression(suspensionCompression);
                        
			wheelInfo.set_m_frictionSlip(friction);
			wheelInfo.set_m_rollInfluence(rollInfluence);

			wheelMeshes[index] = createWheelMesh(radius, width);
		}

		addWheel(true, new Ammo.btVector3(wheelHalfTrackFront, wheelAxisHeightFront, wheelAxisPositionFront), wheelRadiusFront, wheelWidthFront, FRONT_LEFT);
		addWheel(true, new Ammo.btVector3(-wheelHalfTrackFront, wheelAxisHeightFront, wheelAxisPositionFront), wheelRadiusFront, wheelWidthFront, FRONT_RIGHT);
		addWheel(false, new Ammo.btVector3(-wheelHalfTrackBack, wheelAxisHeightBack, wheelAxisPositionBack), wheelRadiusBack, wheelWidthBack, BACK_LEFT);
		addWheel(false, new Ammo.btVector3(wheelHalfTrackBack, wheelAxisHeightBack, wheelAxisPositionBack), wheelRadiusBack, wheelWidthBack, BACK_RIGHT);

		// Sync keybord actions and physics and graphics
		function update(dt) {

			var speed = vehicle.getCurrentSpeedKmHour();

			speedometer.innerHTML = (speed < 0 ? '(R) ' : '') + Math.abs(speed).toFixed(1) + ' km/h';

			breakingForce = 0;
			engineForce = 0;

			if (actions.acceleration) {
				if (speed < -1)
					breakingForce = maxBreakingForce;
				else engineForce = maxEngineForce;
			}
			if (actions.braking) {
				if (speed > 1)
					breakingForce = maxBreakingForce;
				else engineForce = -maxEngineForce / 2;
			}
			if (actions.left) {
				if (vehicleSteering < steeringClamp)
					vehicleSteering += steeringIncrement;
			}
			else {
				if (actions.right) {
					if (vehicleSteering > -steeringClamp)
						vehicleSteering -= steeringIncrement;
				}
				else {
					if (vehicleSteering < -steeringIncrement)
						vehicleSteering += steeringIncrement;
					else {
						if (vehicleSteering > steeringIncrement)
							vehicleSteering -= steeringIncrement;
						else {
							vehicleSteering = 0;
						}
					}
				}
			}

			vehicle.applyEngineForce(engineForce, BACK_LEFT);
			vehicle.applyEngineForce(engineForce, BACK_RIGHT);

			vehicle.setBrake(breakingForce / 2, FRONT_LEFT);
			vehicle.setBrake(breakingForce / 2, FRONT_RIGHT);
			vehicle.setBrake(breakingForce, BACK_LEFT);
			vehicle.setBrake(breakingForce, BACK_RIGHT);

			vehicle.setSteeringValue(vehicleSteering, FRONT_LEFT);
			vehicle.setSteeringValue(vehicleSteering, FRONT_RIGHT);

			var nWheels = vehicle.getNumWheels();
			for (var i = 0; i < nWheels; i++) {
				vehicle.updateWheelTransform(i, true);
				var tm = vehicle.getWheelTransformWS(i);
				var position = tm.getOrigin();
				var q = tm.getRotation();
				wheelMeshes[i].position.set(position.x(), position.y(), position.z());
				wheelMeshes[i].quaternion.set(q.x(), q.y(), q.z(), q.w());
			}

			var tm = vehicle.getChassisWorldTransform();
			var p = tm.getOrigin();
			var q = tm.getRotation();
			chassisMesh.position.set(p.x(), p.y(), p.z());
			chassisMesh.quaternion.set(q.x(), q.y(), q.z(), q.w());
		}

		onRenderFcts.push(update);
	}
        
        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////

        function createObjects() {

        	createBox(new THREE.Vector3(0, -0.5, 0), ZERO_QUATERNION, 75, 1, 75, 0, 2);

        	var quaternion = new THREE.Quaternion(0, 0, 0, 1);
        	quaternion.setFromAxisAngle(new THREE.Vector3(1, 0, 0), -Math.PI / 18);
        	createBox(new THREE.Vector3(0, -1.5, 0), quaternion, 8, 4, 10, 0);

        	var size = .75;
        	var nw = 8;
        	var nh = 6;
        	for (var j = 0; j < nw; j++)
        		for (var i = 0; i < nh; i++)
        			createBox(new THREE.Vector3(size * j - (size * (nw - 1)) / 2, size * i, 10), ZERO_QUATERNION, size, size, size, 10);

        	createVehicle(new THREE.Vector3(0, 4, -20), ZERO_QUATERNION);
        }
        
        createObjects()
})

</script></body>
