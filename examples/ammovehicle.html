<!DOCTYPE html>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script src='vendor/three.js/build/three.min.js'></script>
<script src='vendor/three.js/examples/js/controls/OrbitControls.js'></script>
<script src="vendor/three.js/examples/js/libs/stats.min.js"></script>
<script src="vendor/three.js/examples/js/libs/ammo.js"></script>
<script src="../threex-ammoworld.js"></script>
<script src="../threex-ammocontrols.js"></script>
<script src="../threex-ammovehicle.js"></script>

<script src='js/startupthree.js/startupThree.js'></script>
<body style='margin: 0px; overflow: hidden; text-align:center;'>

        <style>
			#speedometer {
				color: #ffffff;
				background-color: #990000;
				position: absolute;
				bottom: 0px;
				padding: 5px;
			}
        </style>
	<div id="speedometer">0.0 km/h</div>



<script>

startUpTHREEjs(window, {
		// stats : false,
		// cameraControls : false
	}, function(demo){
	

//////////////////////////////////////////////////////////////////////////////////
//		set 3 point lighting						//
//////////////////////////////////////////////////////////////////////////////////

;(function(){
	// add a ambient light
	var light	= new THREE.AmbientLight( 0x020202 ) 
	scene.add( light )
	// add a light in front
	var light	= new THREE.DirectionalLight('white', 0.2)
	light.position.set(0.5, 0.5, -2)
	scene.add( light ) 
})()


;(function(){
	var dirLight = new THREE.DirectionalLight( 0xffffff, 0.8 );
	dirLight.position.set( -15, 15, 15 );
	dirLight.castShadow = true;
	dirLight.shadow.bias = 0.001
	dirLight.shadow.camera.near = 1;
	dirLight.shadow.camera.far = 50;
	dirLight.shadow.camera.right = 25;
	dirLight.shadow.camera.left = - 25;
	dirLight.shadow.camera.top	= 25;
	dirLight.shadow.camera.bottom = - 25;
	dirLight.shadow.mapSize.x = 1024;
	dirLight.shadow.mapSize.y = 1024;
	scene.add( dirLight );
	// scene.add( new THREE.CameraHelper( dirLight.shadow.camera ) );	
})()
        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////
	camera.position.x = -4.84;
	camera.position.y = 4.39;
	camera.position.z = -35.11;
	camera.lookAt( new THREE.Vector3( 0.33, -0.40, 0.85 ) );
        
        ////////////////////////////////////////////////////////////////////////////////
        //          Code Separator
        ////////////////////////////////////////////////////////////////////////////////

        var ammoWorld = new THREEx.AmmoWorld()
        onRenderFcts.push(function(){
        	ammoWorld.update()
        })


        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////

	// // - Global variables -
	var DISABLE_DEACTIVATION = 4;
	var TRANSFORM_AUX = new Ammo.btTransform();
	var ZERO_QUATERNION = new THREE.Quaternion(0, 0, 0, 1);
        
	// Graphics variables
	var materialDynamic = new THREE.MeshPhongMaterial({
                color: 'lightblue'
        })
        var materialStatic = new THREE.MeshPhongMaterial({
                color: 'lightgreen'
        })


        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////

	function createBox(pos, quat, w, l, h, mass, friction) {
		var material = mass > 0 ? materialDynamic : materialStatic;
		var shape = new THREE.BoxGeometry(w, l, h, 1, 1, 1);
		var geometry = new Ammo.btBoxShape(new Ammo.btVector3(w * 0.5, l * 0.5, h * 0.5));

		if(!mass) mass = 0;
		if(!friction) friction = 1;

		var mesh = new THREE.Mesh(shape, material);
                mesh.castShadow = true
                mesh.receiveShadow = true
		mesh.position.copy(pos);
		mesh.quaternion.copy(quat);
		scene.add( mesh );

		var transform = new Ammo.btTransform();
		transform.setIdentity();
		transform.setOrigin(new Ammo.btVector3(pos.x, pos.y, pos.z));
		transform.setRotation(new Ammo.btQuaternion(quat.x, quat.y, quat.z, quat.w));
		var motionState = new Ammo.btDefaultMotionState(transform);

		var localInertia = new Ammo.btVector3(0, 0, 0);
		geometry.calculateLocalInertia(mass, localInertia);

		var rbInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, geometry, localInertia);
		var body = new Ammo.btRigidBody(rbInfo);

		body.setFriction(friction);
		//body.setRestitution(.9);
		//body.setDamping(0.2, 0.2);

		ammoWorld.physicsWorld.addRigidBody( body );

		if (mass > 0) {
			body.setActivationState(DISABLE_DEACTIVATION);
			// Sync physics and graphics
			function sync(dt) {
				var ms = body.getMotionState();
				if (ms) {
					ms.getWorldTransform(TRANSFORM_AUX);
					var p = TRANSFORM_AUX.getOrigin();
					var q = TRANSFORM_AUX.getRotation();
					mesh.position.set(p.x(), p.y(), p.z());
					mesh.quaternion.set(q.x(), q.y(), q.z(), q.w());
				}
			}

			onRenderFcts.push(sync);
		}
	}

        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////
        
        // ground
	createBox(new THREE.Vector3(0, -0.5, 0), ZERO_QUATERNION, 75, 1, 75, 0, 2);

        // tremplin
	var quaternion = new THREE.Quaternion(0, 0, 0, 1);
	quaternion.setFromAxisAngle(new THREE.Vector3(1, 0, 0), -Math.PI / 18);
	createBox(new THREE.Vector3(0, -1.5, 0), quaternion, 8, 4, 10, 0);

        // wall of brick
	var size = .75;
	var nw = 8;
	var nh = 6;
	for (var j = 0; j < nw; j++){
		for (var i = 0; i < nh; i++){                
			createBox(new THREE.Vector3(size * j - (size * (nw - 1)) / 2, size * i, 10), ZERO_QUATERNION, size, size, size, 10);
                }
        }

        // vehicule
	var ammoVehicle = new THREEx.AmmoVehicle(ammoWorld, new THREE.Vector3(0, 4, -20), ZERO_QUATERNION);
        scene.add(ammoVehicle.object3d)
        //////////////////////////////////////////////////////////////////////////////
        //                update speedometer
        //////////////////////////////////////////////////////////////////////////////

        var speedometer = document.getElementById( 'speedometer' );
        onRenderFcts.push(function(){
		var speed = ammoVehicle.vehicle.getCurrentSpeedKmHour();

		speedometer.innerHTML = (speed < 0 ? '(R) ' : '') + Math.abs(speed).toFixed(1) + ' km/h';                
        })
        
        //////////////////////////////////////////////////////////////////////////////
        //                handle keyboard
        //////////////////////////////////////////////////////////////////////////////
	var keysActions = {
		"KeyW":'acceleration',
		"KeyS":'braking',
		"KeyA":'left',
		"KeyD":'right'
	};
                        
	window.addEventListener( 'keydown', function keydown(e) {
		if(keysActions[e.code] === undefined ) return
		ammoVehicle.actions[keysActions[e.code]] = true;
		e.preventDefault();
		e.stopPropagation();
		return false;
	});
	window.addEventListener( 'keyup', function keyup(e) {
		if(keysActions[e.code] === undefined ) return
		ammoVehicle.actions[keysActions[e.code]] = false;
		e.preventDefault();
		e.stopPropagation();
		return false;
	});
})

</script></body>
